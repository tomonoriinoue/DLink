<!doctype html>
<html lang="en" data-vibe="neon">
<head>
<meta charset="utf-8" />
<meta name="robots" content="noindex, nofollow">
<meta name="googlebot" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Beer Vibes Â· Swipe Your Flavor</title>
<meta name="description" content="Swipe like a pro to tune your beer vibe. Share your flavor persona with friends." />
<meta name="theme-color" content="#0b0f14" />
<style>
  :root{
    --bg:#070b10; --bg2:#0b1016; --card:#0f1622; --muted:#9fb0c3; --text:#e6eef6;
    --accent:#ff6b6b; --accent2:#6c8cff;
    --shadow:0 24px 48px rgba(0,0,0,.6);
    --radius:20px;
    --glass:rgba(255,255,255,.06);
  }
  [data-vibe="neon"]{--accent:#ff6b6b;--accent2:#6c8cff;--bg:#070b10;--bg2:#0d121b;--card:#0f1826;--glass:rgba(255,255,255,.08)}
  [data-vibe="pastel"]{--accent:#ffd166;--accent2:#a8e6cf;--bg:#0b0f14;--bg2:#10161f;--card:#141c27;--glass:rgba(255,255,255,.06)}
  [data-vibe="mono"]{--accent:#d1d9e6;--accent2:#a6b4c5;--bg:#040607;--bg2:#090b0f;--card:#0c1016;--glass:rgba(255,255,255,.05)}

  html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--text);
    background:radial-gradient(800px 600px at 80% -10%,#162130 0%,var(--bg2) 50%,var(--bg)100%);
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;
    -webkit-touch-callout:none;-webkit-user-select:none;user-select:none;
    touch-action:none;
  }
  .sheen{
    position:fixed;inset:-20% -20% auto -20%;height:60vh;filter:blur(60px);z-index:-1;
    background:
      radial-gradient(600px 300px at 80% 20%,color-mix(in oklab,var(--accent),transparent 60%)0%,transparent 70%),
      radial-gradient(600px 300px at 20% 0%,color-mix(in oklab,var(--accent2),transparent 70%)0%,transparent 70%);
    animation:pan 26s linear infinite;opacity:.65
  }
  @keyframes pan{0%{transform:translate(-8%,-2%)}50%{transform:translate(8%,4%)}100%{transform:translate(-8%,-2%)}}
  @media(prefers-reduced-motion:reduce){.sheen{animation:none}}

  /* SAFE AREA WRAPPER (v13) -------------------------------------------------
     We observed on Android Chrome that the browser URL bar sits BELOW the OS
     status bar and can overlap content, while env(safe-area-inset-top) = 0.

     Fix:
     - Give a LARGE fixed top padding (48px) PLUS the safe-area inset.
     - Put header INSIDE that paddded region.
     - Also make header "sticky" inside app so it never tucks under the URL bar
       while you scroll screens with overflow.
  */
  .safeWrap{
    width:100vw;max-width:480px;
    min-height:100vh;max-height:100vh;
    display:flex;align-items:stretch;justify-content:center;
    /* bigger reserve at the top */
    padding-top:calc(env(safe-area-inset-top, 0px) + 48px);
    padding-bottom:calc(env(safe-area-inset-bottom, 16px) + 16px);
    box-sizing:border-box;
  }

  .app{
    flex:1 1 auto;
    width:100%;max-width:480px;
    background:linear-gradient(180deg,color-mix(in oklab,var(--card),black 4%)0%,var(--bg2)100%);
    border:0;border-radius:0;box-shadow:none;
    position:relative;overflow:hidden;
    display:flex;flex-direction:column;
    /* no top padding here; safeWrap already created breathing room */
    padding:0 16px 16px;
    box-sizing:border-box;
  }

  header{
    position:sticky; /* NEW: make it stick to the top of the scrolling area */
    top:0;
    z-index:40;
    background:linear-gradient(180deg,var(--bg2) 0%,rgba(0,0,0,0) 100%);
    padding-bottom:12px;

    display:flex;flex-shrink:0;align-items:flex-start;justify-content:space-between;gap:12px;
    margin-bottom:12px;
  }

  .brand{display:flex;align-items:flex-start;gap:10px;max-width:55%}
  .brand h1{margin:0;letter-spacing:.3px;font-size:18px;line-height:1.2}
  .tagline{color:var(--muted);font-size:.8rem;line-height:1.3;max-width:8rem}

  .tools{
    display:flex;flex-wrap:wrap;justify-content:flex-end;gap:6px;max-width:45%;position:relative;
  }
  .chip{
    display:inline-flex;align-items:center;gap:6px;border-radius:999px;
    padding:6px 10px;background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.14);color:var(--text);
    font-size:.75rem;line-height:1.1;cursor:pointer
  }
  .chip[aria-pressed="true"]{
    background:radial-gradient(circle at 0% 0%,var(--accent)0%,var(--accent2)100%);
    color:#1b1408;border-color:transparent;font-weight:600
  }

  /* Help modal */
  .helpModal{
    position:absolute;right:0;top:100%;margin-top:8px;z-index:999;
    background:var(--card);
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 24px 48px rgba(0,0,0,.8);
    border-radius:16px;
    width:min(260px,80vw);
    padding:16px;
    color:var(--text);
    font-size:.8rem;line-height:1.4;
    display:none;
  }
  .helpModal.active{display:block}
  .helpHeader{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
  .helpHeader h2{font-size:.9rem;margin:0;font-weight:600;color:#fff;line-height:1.2}
  .helpCloseBtn{
    background:none;border:0;color:var(--muted);font-size:.8rem;line-height:1;padding:4px;cursor:pointer
  }
  .helpBody ul{margin:.4rem 0 .4rem 1rem;padding:0;font-size:.8rem;line-height:1.4}
  .helpBody li{margin-bottom:.3rem}

  .screen{
    display:none;
    flex-direction:column;
    flex:1 1 auto;
    min-height:0;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    padding-bottom:24px;
    box-sizing:border-box;
    scrollbar-width:none;
  }
  .screen::-webkit-scrollbar{display:none;}
  .screen.active{display:flex}

  #screen1 h2,#screen2 h2,#screen3 h2{font-size:1rem;font-weight:600;margin:0 0 4px}
  #screen1 .muted,#screen2 .muted.top-desc{font-size:.8rem;line-height:1.4}

  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:16px}
  .tile{
    background:color-mix(in oklab,var(--card),black 0%);
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius);
    padding:16px 12px;text-align:center;cursor:pointer;color:#fff;
    position:relative;overflow:hidden;isolation:isolate;
  }
  .tile .title{font-size:1rem;font-weight:700;color:#fff}
  .tile .emoji{font-size:1.4rem;margin-bottom:6px;display:block}
  .tile .muted{font-size:.9rem;line-height:1.4;color:#e6eef6}
  .legend{display:flex;flex-wrap:wrap;gap:6px;margin:14px 0 0;font-size:.7rem;color:var(--muted)}
  .legend span{background:#0e141c;padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.06)}

  #screen2{position:relative}
  #screen2 .top-desc{margin-bottom:10px}
  .progress{height:8px;background:#0e141c;border:1px solid rgba(255,255,255,.06);border-radius:999px;overflow:hidden;position:relative;flex-shrink:0}
  .progress>div{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%;transition:width .25s ease}
  .progress .pct{position:absolute;inset:0;display:grid;place-items:center;font-size:.6rem;color:#c9d7e6;mix-blend:screen}

  .stage{position:relative;flex:1 1 auto;min-height:0;display:flex;align-items:center;justify-content:center;touch-action:none}

  .card{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(360px,90vw);max-width:360px;
    aspect-ratio:3/4;
    background:linear-gradient(180deg,color-mix(in oklab,var(--card),black 0%)0%,color-mix(in oklab,var(--bg2),black 12%)100%);
    border-radius:22px;border:1px solid rgba(255,255,255,.08);
    box-shadow:var(--shadow);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:20px;touch-action:none;-webkit-user-drag:none;color:#fff;overflow:hidden
  }
  .card .badge{position:absolute;top:12px;left:12px;font-size:.7rem;color:#9fb0c3;opacity:.9}
  .card .muted{font-size:.7rem;text-align:center}
  .card h2{margin:8px 0 0;font-size:1.25rem;font-weight:600;text-align:center;line-height:1.3;color:#fff;z-index:3}
  .big-emoji{font-size:2rem;line-height:1;z-index:3;text-shadow:0 8px 24px rgba(0,0,0,.6)}

  /* radial swipe guide */
  .swipeHalo{position:absolute;inset:0;pointer-events:none;z-index:2;display:flex;align-items:center;justify-content:center;font-size:.7rem;line-height:1.2;font-weight:500;color:#fff}
  .swipeCenterIcon{
    position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);
    width:64px;height:64px;border-radius:16px;
    background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.9)0%,rgba(255,255,255,.2)60%,transparent 70%),radial-gradient(circle at 50% 50%,var(--accent)0%,transparent 70%);
    box-shadow:0 30px 60px rgba(0,0,0,.6),0 0 30px color-mix(in oklab,var(--accent),transparent 60%);
    display:flex;align-items:center;justify-content:center;color:#1b1408;font-weight:700;font-size:.8rem;border:1px solid rgba(255,255,255,.4);text-shadow:0 2px 4px rgba(0,0,0,.5)
  }
  .swipeCenterIcon span{display:block;text-align:center;line-height:1.1}
  .swipeArrow{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-align:center;white-space:nowrap;filter:drop-shadow(0 0 6px rgba(255,255,255,.4)) drop-shadow(0 0 12px rgba(108,140,255,.4))}
  .swipeDirIcon{font-size:1rem;font-weight:700;line-height:1;background:radial-gradient(circle at 50% 50%,rgba(255,255,255,.8)0%,rgba(255,255,255,0)60%);-webkit-text-stroke:0.5px rgba(0,0,0,.6)}
  .swipeDirText{font-size:.7rem;line-height:1.2;font-weight:600;color:#e0e9ff;text-shadow:0 2px 4px rgba(0,0,0,.9);opacity:.8;margin-top:2px}
  .arrow-leftUp{left:25%;top:28%}
  .arrow-left{left:18%;top:55%}
  .arrow-down{left:50%;top:78%;transform:translateX(-50%)}
  .arrow-right{left:82%;top:55%;transform:translateX(-50%)}
  .arrow-rightUp{left:75%;top:28%;transform:translateX(-50%)}
  .trail{position:absolute;inset:0;pointer-events:none;z-index:-1;background:radial-gradient(circle at var(--x) var(--y),rgba(108,140,255,.18)0%,transparent 60%);filter:blur(24px);opacity:.6}
  .arrow-leftUp .trail{--x:60%;--y:60%;background:radial-gradient(circle at var(--x) var(--y),rgba(108,140,255,.18)0%,transparent 60%)}
  .arrow-left .trail{--x:65%;--y:50%;background:radial-gradient(circle at var(--x) var(--y),rgba(108,140,255,.12)0%,transparent 60%)}
  .arrow-down .trail{--x:50%;--y:20%;background:radial-gradient(circle at var(--x) var(--y),rgba(255,255,255,.14)0%,transparent 60%)}
  .arrow-right .trail{--x:40%;--y:50%;background:radial-gradient(circle at var(--x) var(--y),rgba(255,107,107,.16)0%,transparent 60%)}
  .arrow-rightUp .trail{--x:35%;--y:35%;background:radial-gradient(circle at var(--x) var(--y),rgba(255,107,107,.22)0%,transparent 60%)}
  .swipeArrow.active .swipeDirIcon{filter:drop-shadow(0 0 6px rgba(255,255,255,.9)) drop-shadow(0 0 20px rgba(255,255,255,1))}
  .swipeArrow.active .swipeDirText{opacity:1;color:#fff}

  .actionbar{flex-shrink:0;display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:16px}
  .btn{
    --padY:12px;--padX:16px;--fs:.8rem;--radius:14px;
    padding:var(--padY) var(--padX);
    border-radius:var(--radius);
    background:#101722;
    border:1px solid rgba(255,255,255,.10);
    color:var(--text);cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
    font-size:var(--fs);font-weight:500;
    min-width:calc(50% - 8px);
    text-align:center
  }
  .btn.primary{background:linear-gradient(180deg,var(--accent)0%,color-mix(in oklab,var(--accent),black 10%)100%);color:#1b1408;font-weight:700;border:none}
  .btn.ghost{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.16)}
  .btn.pill{border-radius:999px}
  .btn.full{flex:1 1 auto;min-width:0}

  /* screen3 profile bars */
  .chartWrap{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:12px 12px 8px;display:flex;flex-direction:column;gap:8px}
  #rows{display:flex;flex-direction:column;gap:8px}
  .rowItem{width:100%}
  .rowItemLabel{font-size:.8rem;font-weight:600;margin-bottom:4px;color:#fff;display:flex;align-items:center;gap:6px;line-height:1.2}
  .barTrack{height:20px;background:rgba(255,255,255,.05);border-radius:999px;position:relative;border:1px solid rgba(255,255,255,.08);overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:999px;width:0%;transition:width .6s cubic-bezier(.2,.8,.2,1);position:relative;font-size:.65rem;font-weight:600;color:#0b0f14;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;line-height:1}

  .persona{display:grid;gap:4px;margin:12px 0 8px;font-size:.75rem;line-height:1.3}
  .persona .title{font-size:.9rem;font-weight:700;color:#fff}
  .persona .desc{color:var(--muted);line-height:1.4;font-size:.75rem}

  #screen4{text-align:center}
  .glass{width:min(240px,70vw);margin:20px auto 8px;display:block}
  .cheers .big{font-size:1.4rem;font-weight:600}
  .cheers .sub{color:var(--muted);font-size:.9rem;margin-bottom:12px}
  .cheers .actionbar{margin-top:0}

  .toast{
    position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
    background:#0e1724;color:#e9f1fb;border:1px solid rgba(255,255,255,.18);
    padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);
    opacity:0;transition:.2s opacity,.2s transform;z-index:9999;
    font-size:.8rem;line-height:1.4;max-width:80vw;text-align:center
  }
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

  .gate{
    position:absolute;inset:0;
    background:
      linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.8)),
      radial-gradient(800px 600px at 80% -10%,#1b2733 0%,#0c1218 50%,#0b0f14 100%);
    display:grid;place-items:center;
    z-index:20;padding:24px;box-sizing:border-box
  }
  .gate .panel{background:var(--card);border:1px solid rgba(255,255,255,.1);padding:20px;border-radius:18px;text-align:center;max-width:320px;width:100%;box-sizing:border-box}
  .gate h2{margin-top:0;font-size:1.1rem;font-weight:600}
  .gate p{font-size:.8rem;line-height:1.4;color:var(--muted);margin-bottom:16px}
  .ageBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .ageBtns .btn{min-width:45%;flex:1 1 auto}

  .confetti{position:fixed;top:-10px;width:8px;height:12px;opacity:.9;transform:translateY(-100px);animation:fall 1.6s linear forwards;border-radius:2px}
  @keyframes fall{to{transform:translateY(110vh) rotate(540deg)}}

  @media(min-width:480px){
    body{align-items:flex-start}
    .safeWrap{
      min-height:640px;max-height:800px;
      margin:24px auto;
      padding-top:48px; /* desktop: also 48px so visual match */
      padding-bottom:24px;
    }
    .app{
      border:1px solid rgba(255,255,255,.06);
      border-radius:24px;
      box-shadow:var(--shadow);
    }
    header{align-items:flex-start}
    .brand h1{font-size:20px}
    .tagline{font-size:.75rem}
    .screen h2{font-size:1.1rem}
    .card{aspect-ratio:3/3.6}
  }
</style>
</head>
<body>
<div class="sheen" aria-hidden="true"></div>

<div class="safeWrap">
  <div class="app" id="app" aria-live="polite">
    <header>
      <div class="brand">
        <svg width="32" height="32" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="64" y2="64" gradientUnits="userSpaceOnUse">
              <stop stop-color="var(--accent2)"/>
              <stop offset="1" stop-color="var(--accent)"/>
            </linearGradient>
          </defs>
          <rect x="4" y="4" width="56" height="56" rx="14" fill="#0d1420" stroke="url(#g)"/>
          <path d="M22 20h20v16a10 10 0 0 1-10 10a10 10 0 0 1-10-10V20z" fill="var(--accent)"/>
          <path d="M42 20h-20l2-4h16l2 4z" fill="#fff" opacity=".9"/>
        </svg>
        <div style="display:flex;flex-direction:column;line-height:1.2;">
          <h1>Beer Vibes</h1>
          <span class="tagline">Swipe â tune â share</span>
        </div>
      </div>

      <div class="tools">
        <button class="chip" id="vibeNeon" aria-pressed="true">â¨ Neon</button>
        <button class="chip" id="vibePastel" aria-pressed="false">ð¬ Pastel</button>
        <button class="chip" id="vibeMono" aria-pressed="false">ð¤ Mono</button>
        <button class="chip" id="soundToggle" aria-pressed="true">ð</button>
        <button class="chip" id="hapticToggle" aria-pressed="true">ð³</button>
        <button class="chip" id="helpBtn" aria-pressed="false">â</button>

        <div class="helpModal" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
          <div class="helpHeader">
            <h2 id="helpTitle">Help</h2>
            <button class="helpCloseBtn" id="closeHelp" aria-label="Close help">â</button>
          </div>
          <div class="helpBody" id="helpContent"></div>
        </div>
      </div>
    </header>

    <section class="gate" id="ageGate" role="alertdialog" aria-labelledby="gateTitle" aria-describedby="gateDesc">
      <div class="panel">
        <h2 id="gateTitle">ð» Are you 21+?</h2>
        <p id="gateDesc">We use this app to explore beer flavors. If you're under 21, consider NA options offline.</p>
        <div class="ageBtns">
          <button class="btn primary pill" id="gateYes">Yes</button>
          <button class="btn ghost pill" id="gateNo">No</button>
        </div>
      </div>
    </section>

    <section class="screen active" id="screen1">
      <div>
        <h2>1. Pick a Base Style</h2>
        <p class="muted">Weâll preload typical flavor levels. Youâll tweak them next.</p>
      </div>

      <div class="cards" id="styleCards"></div>

      <div class="legend">
        <span>IPA</span><span>PA</span><span>Wheat</span><span>Pils</span>
      </div>
    </section>

    <section class="screen" id="screen2">
      <div>
        <h2>2. Swipe the Card</h2>
        <p class="muted top-desc">Drag in any direction. Bigger swipe = stronger change.</p>
      </div>

      <div class="progress" aria-label="Progress">
        <div id="progressBar"></div>
        <div class="pct" id="progressPct">0%</div>
      </div>

      <div class="stage" id="stage"></div>

      <div class="actionbar" id="fallbackBar">
        <button class="btn pill ghost full" data-act="left">â¬ Mild</button>
        <button class="btn pill ghost full" data-act="down">â¬ Keep</button>
        <button class="btn pill ghost full" data-act="right">â¡ Bold</button>
        <button class="btn pill ghost full" id="undoBtn">â² Undo</button>
      </div>
    </section>

    <section class="screen" id="screen3">
      <div><h2>3. Your Flavor Map</h2></div>

      <div class="chartWrap" id="rowsWrapper">
        <div id="rows"></div>
      </div>

      <div class="persona" id="persona">
        <div class="title">Persona: <span id="personaName">â</span></div>
        <div class="desc" id="personaDesc">â</div>
      </div>

      <div class="actionbar shareRow">
        <button class="btn ghost pill full" id="restartBtn">âº Restart</button>
        <button class="btn primary pill full" id="shareBtn">ð¤ Share</button>
        <button class="btn pill full" id="decideBtn">â Decide</button>
      </div>
    </section>

    <section class="screen" id="screen4">
      <div class="cheers">
        <svg class="glass" viewBox="0 0 200 280" xmlns="http://www.w3.org/2000/svg" aria-label="Beer glass illustration">
          <defs>
            <linearGradient id="foamG" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="#ffffff"/>
              <stop offset="1" stop-color="#f3f6f9"/>
            </linearGradient>
            <linearGradient id="beerG" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="#ffe08a"/>
              <stop offset="1" stop-color="#ffb703"/>
            </linearGradient>
          </defs>
          <rect x="40" y="20" width="120" height="220" rx="18" ry="18" fill="#dfe7f1" opacity=".08" stroke="#9fb0c3" stroke-opacity=".25"/>
          <rect x="44" y="70" width="112" height="160" rx="12" fill="url(#beerG)"/>
          <ellipse cx="100" cy="68" rx="56" ry="22" fill="url(#foamG)"/>
          <circle cx="70" cy="60" r="6" fill="#fff"/>
          <circle cx="90" cy="56" r="5" fill="#fff"/>
          <circle cx="110" cy="60" r="7" fill="#fff"/>
          <circle cx="130" cy="58" r="5" fill="#fff"/>
          <g fill="#fff" opacity=".35">
            <circle cx="80" cy="180" r="3"/>
            <circle cx="120" cy="160" r="2.5"/>
            <circle cx="100" cy="200" r="2.5"/>
            <circle cx="95" cy="150" r="2"/>
          </g>
        </svg>

        <div class="big">Enjoy your beer!</div>
        <div class="sub">One more round?</div>

        <div class="actionbar" style="margin-top:0;">
          <button class="btn primary pill full" id="oneMoreBtn">ðº One More</button>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(()=>{
  const FLAVORS=[
    {key:'hop_aroma', label:'Hop Aroma',    emoji:'ð¿'},
    {key:'malt_aroma',label:'Malt Aroma',   emoji:'ð'},
    {key:'bitterness',label:'Bitterness',   emoji:'â¡ï¸'},
    {key:'sweetness', label:'Sweetness',    emoji:'ð¯'},
    {key:'citrus',    label:'Citrus',       emoji:'ð'},
    {key:'pine',      label:'Pine/Resin',   emoji:'ð²'},
    {key:'yeast',     label:'Yeast/Fruity', emoji:'ð'},
    {key:'body',      label:'Body',         emoji:'ðª'}
  ];

  const DEFAULTS={
    IPA:          [6,2,6,1,5,4,2,4],
    PA:           [4,3,4,2,2,1,2,3],
    'Wheat Beer': [3,2,2,3,3,0,4,2],
    Pilsner:      [3,2,3,1,2,0,1,2]
  };

  const STYLE_EMOJI={IPA:'ðº',PA:'ð»','Wheat Beer':'ð¾ðº',Pilsner:'ðºâ¨'};
  const DELTAS={down:0,left:-1,leftUp:-2,right:1,rightUp:2};

  let state={style:null,base:[],answers:{},index:0};
  let history=[];

  const settings={
    sound:JSON.parse(localStorage.getItem('sound')??'true'),
    haptics:JSON.parse(localStorage.getItem('haptics')??'true'),
    vibe:localStorage.getItem('vibe')??'neon',
    ageok:JSON.parse(localStorage.getItem('ageok')??'false')
  };

  const $ = s=>document.querySelector(s);
  const $$= s=>document.querySelectorAll(s);

  const styleCards  = $('#styleCards');
  const stage       = $('#stage');
  const progressBar = $('#progressBar');
  const progressPct = $('#progressPct');
  const rows        = $('#rows');
  const toastEl     = $('#toast');
  const helpModal   = $('#helpModal');
  const helpContent = $('#helpContent');

  const toast = msg => {
    toastEl.textContent=msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'),1400);
  };

  const show = id => {
    $$('.screen').forEach(s=>s.classList.remove('active'));
    $(id).classList.add('active');
  };

  let audioCtx=null;
  function initAudio(){if(!settings.sound||audioCtx)return;try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}
  function beep(freq=520,dur=.05,type='sine'){
    if(!settings.sound||!audioCtx)return;
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.type=type;o.frequency.value=freq;
    o.connect(g);g.connect(audioCtx.destination);
    g.gain.setValueAtTime(.0001,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(.08,audioCtx.currentTime+.01);
    g.gain.exponentialRampToValueAtTime(.0001,audioCtx.currentTime+dur);
    o.start();o.stop(audioCtx.currentTime+dur);
  }
  function vibe(pattern=[12]){if(settings.haptics&&navigator.vibrate)navigator.vibrate(pattern);} 

  function applyVibe(name){
    document.documentElement.setAttribute('data-vibe',name);
    ['vibeNeon','vibePastel','vibeMono'].forEach(id=>{
      $('#'+id).setAttribute('aria-pressed', String(id.toLowerCase().includes(name)));
    });
    localStorage.setItem('vibe',name);
  }
  applyVibe(settings.vibe);

  const ageGate = $('#ageGate');
  if(settings.ageok){ageGate.style.display='none';}
  $('#gateYes').onclick=()=>{
    localStorage.setItem('ageok','true');
    ageGate.style.display='none';
    toast('Welcome!');
  };
  $('#gateNo').onclick=()=>{
    toast('NA options offline âï¸');
  };

  $('#soundToggle').setAttribute('aria-pressed',String(settings.sound));
  $('#hapticToggle').setAttribute('aria-pressed',String(settings.haptics));
  $('#soundToggle').onclick=e=>{
    settings.sound=!settings.sound;
    localStorage.setItem('sound',String(settings.sound));
    e.currentTarget.setAttribute('aria-pressed',String(settings.sound));
    toast(settings.sound?'Sound on':'Sound off');
  };
  $('#hapticToggle').onclick=e=>{
    settings.haptics=!settings.haptics;
    localStorage.setItem('haptics',String(settings.haptics));
    e.currentTarget.setAttribute('aria-pressed',String(settings.haptics));
    toast(settings.haptics?'Haptics on':'Haptics off');
  };
  $('#vibeNeon').onclick =()=>applyVibe('neon');
  $('#vibePastel').onclick=()=>applyVibe('pastel');
  $('#vibeMono').onclick  =()=>applyVibe('mono');

  function getActiveStep(){
    const active=document.querySelector('.screen.active');
    if(!active)return 1;
    if(active.id==='screen1')return 1;
    if(active.id==='screen2')return 2;
    if(active.id==='screen3')return 3;
    return 1;
  }

  function stepHelpHTML(step){
    if(step===1){
      return `
        <h2 style="margin:0 0 6px;font-size:.9rem;color:#fff;">Step 1: Choose Your Base Style</h2>
        <p>Select a beer style (IPA, Pale Ale, Wheat, Pilsner). This defines your starting balance of hop aroma, malt sweetness, body, etc. You will customize it in the next step.</p>
      `;
    }
    if(step===2){
      return `
        <h2 style="margin:0 0 6px;font-size:.9rem;color:#fff;">Step 2: Swipe to Adjust</h2>
        <p>Swipe the card in any direction to tune that flavor:</p>
        <ul>
          <li>â Very Strong</li>
          <li>â Slightly Strong</li>
          <li>â Keep (no change)</li>
          <li>â Slightly Milder</li>
          <li>â Very Mild</li>
        </ul>
        <p>Do this for all flavor cards. Each swipe reshapes your final beer profile.</p>
      `;
    }
    if(step===3){
      return `
        <h2 style="margin:0 0 6px;font-size:.9rem;color:#fff;">Step 3: Your Flavor Profile</h2>
        <p>Your final beer is summarized across nine traits (Aroma Hop, Bitterness, Malt Sweetness, Body & Richness, Fruitiness, Spiciness, Freshness / Crispness, Yeast Character, Sourness).</p>
        <p>Use Restart to try another base style, Share to send your profile, or Decide when you're happy.</p>
      `;
    }
    return `<p>Need help? Pick a style, swipe flavors, then review your profile.</p>`;
  }

  function openHelp(){
    helpContent.innerHTML = stepHelpHTML(getActiveStep());
    helpModal.classList.add('active');
  }
  function closeHelp(){
    helpModal.classList.remove('active');
  }
  $('#helpBtn').onclick = openHelp;
  $('#closeHelp').onclick = closeHelp;

  function selectStyle(name){
    state={style:name,base:[...DEFAULTS[name]],answers:{},index:0};
    history=[];
    buildSwipeCards();
    updateProgress();
    show('#screen2');
  }
  function renderStyleTiles(){
    styleCards.innerHTML='';
    Object.keys(DEFAULTS).forEach(name=>{
      const el=document.createElement('button');
      el.className='tile';
      const icon=STYLE_EMOJI[name]||'ðº';
      el.innerHTML=`
        <span class="emoji">${icon}</span>
        <div class="title">${name}</div>
        <div class="muted">Tap to start</div>
      `;
      el.addEventListener('click',()=>selectStyle(name));
      styleCards.appendChild(el);
    });
  }
  renderStyleTiles();

  function haloGuideHTML(){
    return `
      <div class="swipeHalo" aria-hidden="true">
        <div class="swipeCenterIcon"><span>SWIPE</span></div>
        <div class="swipeArrow arrow-leftUp" data-dir="leftUp"><div class="trail"></div><div class="swipeDirIcon">â</div><div class="swipeDirText">Very Mild</div></div>
        <div class="swipeArrow arrow-left" data-dir="left"><div class="trail"></div><div class="swipeDirIcon">â</div><div class="swipeDirText">Mild</div></div>
        <div class="swipeArrow arrow-down" data-dir="down"><div class="trail"></div><div class="swipeDirIcon">â</div><div class="swipeDirText">Keep</div></div>
        <div class="swipeArrow arrow-right" data-dir="right"><div class="trail"></div><div class="swipeDirIcon">â</div><div class="swipeDirText">Bold</div></div>
        <div class="swipeArrow arrow-rightUp" data-dir="rightUp"><div class="trail"></div><div class="swipeDirIcon">â</div><div class="swipeDirText">Very Bold</div></div>
      </div>`;
  }

  function buildSwipeCards(){
    stage.querySelectorAll('.card').forEach(n=>n.remove());
    for(let i=FLAVORS.length-1;i>=0;i--){
      const f=FLAVORS[i];
      const c=document.createElement('div');
      c.className='card';
      c.dataset.index=i;
      c.innerHTML=`
        <div class="badge">${i+1} / ${FLAVORS.length}</div>
        <div class="muted">Adjust Flavor</div>
        <div class="big-emoji" aria-hidden="true">${f.emoji}</div>
        <h2>${f.label}</h2>
        ${haloGuideHTML()}
      `;
      makeSwipeable(c,i);
      stage.appendChild(c);
    }
    const all=Array.from(stage.querySelectorAll('.card'));
    all.forEach((el,idx,arr)=>{if(idx!==arr.length-1)el.style.opacity=.85;});
  }

  function updateProgress(){
    const pct=Math.round((state.index/FLAVORS.length)*100);
    progressBar.style.width=pct+'%';
    progressPct.textContent=pct+'%';
  }

  function answer(index,dir){
    const key=FLAVORS[index].key;
    state.answers[key]=DELTAS[dir];
    state.index=Math.min(index+1,FLAVORS.length);
    history.push(index);
    updateProgress();

    const top=[...stage.querySelectorAll('.card')].find(el=>+el.dataset.index===index);
    if(top){
      top.style.transition='transform .25s ease, opacity .22s ease';
      const off={right:[220,-10],rightUp:[220,-180],left:[-220,-10],leftUp:[-220,-180],down:[0,220]}[dir];
      top.style.transform=`translate(${off[0]}px, ${off[1]}px) rotate(${off[0]*0.04}deg)`;
      top.style.opacity=0;
      setTimeout(()=>top.remove(),240);
    }

    initAudio();
    const tone={right:620,rightUp:760,left:420,leftUp:360,down:300}[dir]||520;
    beep(tone,.05);
    vibe([dir.includes('Up')?28:16]);

    if(state.index>=FLAVORS.length){
      renderChart();
      show('#screen3');
    }
  }

  function commitCurrent(dir){
    const next=state.index;
    if(next>=FLAVORS.length)return;
    answer(next,dir);
  }

  function setHintActive(dir){
    $$('.swipeArrow').forEach(a=>{
      a.classList.toggle('active',a.dataset.dir===dir);
    });
  }
  function clearHints(){
    $$('.swipeArrow').forEach(a=>a.classList.remove('active'));
  }

  function makeSwipeable(el,index){
    let startX=0,startY=0,dragging=false,dx=0,dy=0;
    el.addEventListener('pointerdown',e=>{
      dragging=true;startX=e.clientX;startY=e.clientY;
      el.setPointerCapture(e.pointerId);
      initAudio();
    });
    el.addEventListener('pointermove',e=>{
      if(!dragging)return;
      dx=e.clientX-startX;dy=e.clientY-startY;
      el.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px)) rotate(${dx*0.04}deg)`;
      el.style.opacity=Math.max(.6,1-Math.hypot(dx,dy)/800);
      const dir=detectDirection(dx,dy);
      setHintActive(dir);
    });
    el.addEventListener('pointerup',e=>{
      if(!dragging)return;
      dragging=false;
      el.releasePointerCapture(e.pointerId);
      const dir=detectDirection(dx,dy);
      const dist=Math.hypot(dx,dy);
      const commit=dist>60 && dir!=='none';
      if(commit){
        answer(index,dir);
      }else{
        el.style.transition='transform .18s ease, opacity .18s ease';
        el.style.transform='translate(-50%,-50%)';
        el.style.opacity=1;
        setTimeout(()=>{el.style.transition='';},180);
      }
      clearHints();dx=dy=0;
    });
  }

  function detectDirection(dx,dy){
    if(Math.hypot(dx,dy)<20)return'none';
    const angle=Math.atan2(dy,dx)*180/Math.PI;
    if(angle>=-80 && angle<=-10)  return'rightUp';
    if(angle<=-100&& angle>=-170) return'leftUp';
    if(angle>-10 && angle<10)     return'right';
    if(angle>=170|| angle<=-170)  return'left';
    if(angle>=30 && angle<=150)   return'down';
    return'none';
  }

  $('#fallbackBar').addEventListener('click',e=>{
    const dir=e.target?.dataset?.act;
    if(!dir)return;
    commitCurrent(dir);
  });

  $('#undoBtn').onclick=()=>{
    if(!history.length)return toast('Nothing to undo');
    const lastIdx=history.pop();
    const key=FLAVORS[lastIdx].key;
    delete state.answers[key];
    state.index=lastIdx;
    updateProgress();
    injectCard(lastIdx);
    toast('Undid last swipe');
  };

  function injectCard(i){
    const f=FLAVORS[i];
    const c=document.createElement('div');
    c.className='card';
    c.dataset.index=i;
    c.innerHTML=`
      <div class="badge">${i+1} / ${FLAVORS.length}</div>
      <div class="muted">Adjust Flavor</div>
      <div class="big-emoji" aria-hidden="true">${f.emoji}</div>
      <h2>${f.label}</h2>
      ${haloGuideHTML()}
    `;
    makeSwipeable(c,i);
    stage.appendChild(c);
  }

  document.addEventListener('keydown',e=>{
    const map={ArrowRight:'right',ArrowLeft:'left',ArrowDown:'down',ArrowUp:'rightUp'};
    if(!map[e.key])return;
    if($('#screen2').classList.contains('active')){
      commitCurrent(map[e.key]);
      e.preventDefault();
    }
  });

  function computeOutputProfile(finalFlavorArray){
    const g=Object.fromEntries(finalFlavorArray.map(x=>[x.key,x.value]));
    function clamp7(v){return Math.max(0,Math.min(7,v));}

    const aromaHopRaw = (g.hop_aroma*0.5 + g.citrus*0.3 + g.pine*0.2);
    const aromaHop    = clamp7(Math.round(aromaHopRaw));

    const bitterness  = clamp7(g.bitterness);

    const maltSweetRaw = (g.malt_aroma*0.6 + g.sweetness*0.6);
    const maltSweet    = clamp7(Math.round(maltSweetRaw/1.2));

    const bodyRichRaw = (g.body*0.6 + g.sweetness*0.2 + g.malt_aroma*0.2);
    const bodyRich    = clamp7(Math.round(bodyRichRaw));

    const fruitRaw = (g.yeast*0.5 + g.citrus*0.5);
    const fruit    = clamp7(Math.round(fruitRaw));

    const spiceRaw = (g.yeast*0.6 + g.pine*0.4);
    const spice    = clamp7(Math.round(spiceRaw));

    const crispRaw = (g.bitterness*0.4 + g.citrus*0.4 + (7-g.body)*0.4)/1.2;
    const crisp    = clamp7(Math.round(crispRaw));

    const yeastChar = clamp7(Math.round(g.yeast));

    const sourRaw = (g.citrus*0.6 + (7-g.sweetness)*0.4);
    const sour    = clamp7(Math.round(sourRaw));

    return [
      {label:'Aroma Hop',             value:aromaHop},
      {label:'Bitterness',            value:bitterness},
      {label:'Malt Sweetness',        value:maltSweet},
      {label:'Body & Richness',       value:bodyRich},
      {label:'Fruitiness',            value:fruit},
      {label:'Spiciness',             value:spice},
      {label:'Freshness / Crispness', value:crisp},
      {label:'Yeast Character',       value:yeastChar},
      {label:'Sourness',              value:sour}
    ];
  }

  function renderChart(){
    rows.innerHTML='';

    const finalRaw=FLAVORS.map((f,i)=>{
      const baseVal=state.base[i];
      const delta=state.answers[f.key]??0;
      const v=clamp(baseVal+delta,0,7);
      return{key:f.key,label:f.label,emoji:f.emoji,value:v};
    });

    const outMetrics=computeOutputProfile(finalRaw);

    outMetrics.forEach(row=>{
      const wrap=document.createElement('div');
      wrap.className='rowItem';

      const label=document.createElement('div');
      label.className='rowItemLabel';
      label.textContent=row.label;

      const barTrack=document.createElement('div');
      barTrack.className='barTrack';

      const bar=document.createElement('div');
      bar.className='bar';
      bar.setAttribute('role','img');
      bar.setAttribute('aria-label',`${row.label}: ${row.value} / 7`);
      bar.textContent=row.value+' / 7';
      bar.style.width='0%';

      requestAnimationFrame(()=>{
        bar.style.width=(row.value/7*100)+'%';
      });

      barTrack.appendChild(bar);
      wrap.appendChild(label);
      wrap.appendChild(barTrack);
      rows.appendChild(wrap);
    });

    const p=computePersona(finalRaw);
    $('#personaName').textContent=p.name;
    $('#personaDesc').textContent=p.desc;

    buildShareLink(finalRaw);
  }

  function clamp(n,a,b){return Math.max(a,Math.min(b,n));}

  function computePersona(final){
    const g=Object.fromEntries(final.map(x=>[x.key,x.value]));
    let name='Chill Sipper',desc='Balanced tastes with room to explore. You vibe with easy drinkers and clean finishes.';
    if(g.hop_aroma>=5 && g.citrus>=4){
      name='Hazy Hypebeast';
      desc='Juicy, hazy, fruit-forward. You chase tropical clouds and citrus bursts.';
    }else if(g.bitterness>=5 && g.malt_aroma<=3){
      name='Bitter Boss';
      desc='Crisp and snappy. You respect a firm IBU and a dry finish.';
    }else if(g.sweetness>=4 && g.malt_aroma>=4){
      name='Dessert Drifter';
      desc='Sweet malts and pastry vibes. Youâre here for cozy sips.';
    }else if(g.pine>=4){
      name='Forest Ranger';
      desc='Resinous, piney, old-school hop energy with a modern twist.';
    }else if(g.yeast>=5){
      name='Fruity Funkster';
      desc='Yeast-driven esters, banana/clove. You like character.';
    }
    return {name,desc};
  }

  function buildShareLink(finalRaw){
    const payload={style:state.style,answers:state.answers,base:state.base};
    const s=btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const url=`${location.origin}${location.pathname}?s=${s}`;
    $('#shareBtn').onclick=async()=>{
      try{
        if(navigator.share){
          await navigator.share({title:'My Beer Vibe',text:`${state.style} Â· ${$('#personaName').textContent}`,url});
        }else{
          await navigator.clipboard.writeText(url);
          toast('Link copied');
        }
      }catch(e){
        console.debug(e);
        toast('Could not share');
      }
    };
  }

  (function hydrateFromURL(){
    const params=new URLSearchParams(location.search);
    const s=params.get('s');
    if(!s)return;
    try{
      const obj=JSON.parse(decodeURIComponent(escape(atob(s))));
      if(obj?.style && DEFAULTS[obj.style]){
        state={
          style:obj.style,
          base:obj.base ?? [...DEFAULTS[obj.style]],
          answers:obj.answers ?? {},
          index:FLAVORS.length
        };
        renderChart();
        show('#screen3');
      }
    }catch(e){console.debug('bad state',e);}
  })();

  $('#helpBtn').onclick = openHelp;
  $('#closeHelp').onclick = closeHelp;

  $('#restartBtn').onclick =()=>{show('#screen1');};
  $('#decideBtn').onclick  =()=>{show('#screen4');popConfetti();};
  $('#oneMoreBtn').onclick =()=>{show('#screen1');};

  function popConfetti(){
    if(window.matchMedia('(prefers-reduced-motion: reduce)').matches)return;
    const cs=[getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),getComputedStyle(document.documentElement).getPropertyValue('--accent2').trim(),'#ffffff'];
    for(let i=0;i<60;i++){
      const c=document.createElement('div');
      c.className='confetti';
      c.style.left=Math.random()*100+'vw';
      c.style.background=cs[i%cs.length];
      c.style.transform='translateY(-100px) rotate('+(Math.random()*360)+'deg)';
      c.style.animationDuration=(1.2+Math.random()*0.8)+'s';
      c.style.opacity=(0.6+Math.random()*0.4);
      document.body.appendChild(c);
      setTimeout(()=>c.remove(),2000);
    }
    initAudio();
    beep(880,.08,'square');
    vibe([25,10]);
  }
})();
</script>
</body>
</html>
